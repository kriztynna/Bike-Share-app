{% extends "base.html" %}
    {% block head %}
        <title>busybici: totals</title>
    {% endblock %}
    {% block body %}
        <br>
        <h1>total bikes and docks</h1>
            <p>This page shows total bikes available and total docks available, and how these have changed over a recent period of time. I'm still working on making this data set more useful. One of the things I'd like to be able to do is show an estimate of the total bikes in circulation over time.</p>
                <select id="time_dropdown" name="time_req" onchange="updateChart()">
                    {% for t in timespans %}
                        {% set sel="" %}
                        {% if t[1] == time_req %}
                            {% set sel="selected" %}
                        {% endif %}
                        <option value={{t[1]}} {{sel}}>{{t[0]}}</option>
                    {% endfor %}
                </select>
                <label class="checkbox">
                    <input type="checkbox" id="bikes_checkbox" name="bikes_req" value="checked" {{bikes_req}} onchange="updateChart()">
                    Available bikes
                </label>
                <label class="checkbox" display:inline>
                    <input type="checkbox" id="docks_checkbox" name="docks_req" value="checked" {{docks_req}} onchange="updateChart()">
                    Available docks
                </label>
                <label class="checkbox" display:inline>
                    <input type="checkbox" id="errors_checkbox" name="errors_req" value="checked" {{errors_req}} onchange="updateChart()">
                    Station errors
                </label>
	    <hr>
	    <div id="chart_div"></div>

        <!-- JavaScript for chart-->
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">
            google.load('visualization', '1.0', {'packages':['corechart']});
            function handleData(){
                if (request.readyState == 4 && request.status == 200){
                    var json_output = request.responseText;
                    chartJSON = JSON.parse(json_output);

                    var data = new google.visualization.DataTable();
                    columns = chartJSON.dataTable.cols
                    for (var i=0;i<columns.length;i++){
                        data.addColumn(columns[i].type, columns[i].id);
                    }

                    rows = chartJSON.dataTable.rows
                    rowsToAdd = new Array();
                    for (var i=0;i<rows.length;i++){
                        var row = new Array();
                        for (var j=0;j<rows[i].c.length;j++){
                            if (j==0) {
                                var value = new Date(rows[i].c[j].v);
                            }
                            else {
                                var value = rows[i].c[j].v;
                            }
                            row.push(value);
                        }
                        rowsToAdd.push(row);
                    }
                    data.addRows(rowsToAdd);

                    var options = chartJSON.options;

                    var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
                    chart.draw(data, options);
                }
            }

            function drawChart(){
                request = new XMLHttpRequest();
                request.onreadystatechange = handleData;
                var req = 'totalsjson?'+'time_req='+{{time_req}}+'&bikes_req='+'{{bikes_req}}'+'&docks_req='+'{{docks_req}}'+'&errors_req='+'{{errors_req}}';
                var encoded_req = encodeURI(req);
                request.open("GET",encoded_req,true);
                request.send();
            }
            drawChart();

            function updateChart(){
                var time_dropdown = document.getElementById('time_dropdown');
                var time_req = time_dropdown.options[time_dropdown.selectedIndex].value;                
                var bikes_checkbox = document.getElementById('bikes_checkbox');
                var bikes_req
                if (bikes_checkbox.checked==true){
                    bikes_req = 'checked';
                }
                else {
                    bikes_req=''
                }
                
                var docks_checkbox = document.getElementById('docks_checkbox');
                var docks_req
                if (docks_checkbox.checked==true){
                    docks_req = 'checked';
                }
                else {
                    docks_req=''
                }
                
                var errors_checkbox = document.getElementById('errors_checkbox');
                var errors_req
                if (errors_checkbox.checked==true){
                    errors_req = 'checked';
                }
                else {
                    errors_req=''
                }

                request = new XMLHttpRequest();
                request.onreadystatechange = handleData;

                var req = 'totalsjson?'+'time_req='+time_req+'&bikes_req='+bikes_req+'&docks_req='+docks_req+'&errors_req='+errors_req;
                var encoded_req = encodeURI(req);
                request.open("GET",encoded_req,true);
                request.send();
            }
            updateChart();
        </script>
    {% endblock %}